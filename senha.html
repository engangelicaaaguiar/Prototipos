<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Angel Telemed — Criar senha</title>
<link rel="stylesheet" href="assets/css/style.css">
<style>
  .error { color:#c0392b; font-size:14px; margin-top:8px; display:none; }
  .show { display:block; }
  .eye { cursor:pointer; width:26px; height:26px; }
  .password-box { position:relative; }
  .password-box img { position:absolute; right:12px; top:12px; }
</style>
</head>
<body>

<div class="app">
  <div class="topbar">
    <img src="assets/img/icon-back.svg" class="back" onclick="history.back()">
    <div class="title">Crie sua senha</div>
  </div>

  <div class="main">
    <p>Uma senha protege seus dados de acesso.</p>

    <label>Digite sua senha (4 dígitos)</label>
    <div class="password-box">
      <input id="pass1" type="password" maxlength="4" class="input" inputmode="numeric">
      <img id="eye1" class="eye" src="assets/img/icon-eye.svg">
    </div>

    <label>Confirme sua senha</label>
    <div class="password-box">
      <input id="pass2" type="password" maxlength="4" class="input" inputmode="numeric">
      <img id="eye2" class="eye" src="assets/img/icon-eye.svg">
    </div>

    <div id="err" class="error"></div>

    <button id="btn-final" class="btn btn-primary" disabled>Finalizar cadastro</button>
  </div>
</div>

<script>
  const p1 = document.getElementById("pass1");
  const p2 = document.getElementById("pass2");
  const btn = document.getElementById("btn-final");
  const err = document.getElementById("err");
  const eye1 = document.getElementById("eye1");
  const eye2 = document.getElementById("eye2");

  let passHistory = JSON.parse(localStorage.getItem("angel.passwordHistory") || "[]");

  function togglePassword(input, icon) {
    input.type = input.type === "password" ? "text" : "password";
  }

  eye1.onclick = () => togglePassword(p1);
  eye2.onclick = () => togglePassword(p2);

  function validate() {
    const v1 = p1.value;
    const v2 = p2.value;

    err.classList.remove("show");
    btn.disabled = true;

    if (!/^\d{4}$/.test(v1)) {
      err.textContent = "A senha deve conter exatamente 4 números.";
      err.classList.add("show");
      return;
    }

    if (v1 !== v2) {
      err.textContent = "As senhas não coincidem.";
      err.classList.add("show");
      return;
    }

    if (passHistory.includes(v1)) {
      err.textContent = "Você já usou esta senha recentemente. Escolha outra.";
      err.classList.add("show");
      return;
    }

    err.classList.remove("show");
    btn.disabled = false;
  }

  p1.addEventListener("input", validate);
  p2.addEventListener("input", validate);

  btn.addEventListener("click", () => {
    const v1 = p1.value;

    passHistory.unshift(v1);
    passHistory = passHistory.slice(0,2);
    localStorage.setItem("angel.passwordHistory", JSON.stringify(passHistory));

    localStorage.setItem("angel.password", v1);

    location.href = "conclusao.html";
  });
</script>

</body>
</html>
